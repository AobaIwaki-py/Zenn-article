---
title: "PrometheusとNode Exporterで収集した情報をGrafanaで可視化する"
emoji: "👻"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["linux","docker","prometheus",'grafana']
published: false
---
# この記事の概要
この記事では、Prometheus、Node Exporter、Grafanaを利用したリッチなサーバー監視システムをミニマルに構成する方法を解説します。以下にPrometheus周りの構成図を示していますが、私が今回解説するのはオレンジ色の角が丸い四角形で囲まれた部分についてのみです。Alert Managerなどその他の機能を実装したい方は他の方の記事や公式ドキュメントをご覧ください。

![](/images/a612bf497c59ca/2023-03-11-17-59-59.png)

## Prometheusとは

## Node Exporterとは

## Grafanaとは


# 情報収集用のサーバーにPrometheusを設定する
このセクションでは、`docker run`、`docker-compose up`、プレコンパイルされたバイナリファイルを用いた3種類の方法でPrometheusの設定方法を解説します。自分にとって一番やりやすい方法で設定することをお勧めします。

- `prometheus.yml` の中身は設定方法によらず同一です。
- この記事では、デフォルトポートを以下のように設定しています。実装環境によってこれらのポートが埋まっている場合は、ポートの重複に注意してください。
  - Prometheus : 9090
  - Node Exporter : 9100
  - Grafana : 3000
```yaml:prometheus.yml
global:
  scrape_interval:     15s # By default, scrape targets every 15 seconds.
  external_labels:
    monitor: 'codelab-monitor'

scrape_configs:
  - job_name: prometheus
    metrics_path: /metrics
    scrape_interval: 5s
    static_configs:
      - targets: ['{監視対象のIPアドレス}:9100']
```

## docker runを用いた設定
- 公式のDocker image
  - [prom/prometheus - Docker Image | Docker Hub](https://hub.docker.com/r/prom/prometheus)
- 以下のコマンドとオプションについて説明します。
  - `docker run`でdocker imageを起動します。imageがローカルにない場合は、インターネット上から自動的に取得してくれます。
  - そのままだとフォアグラウンドで実行されるので、`-d`をつけてバックグランドで起動します。
  - `-p`でポートを指定します。左側がホストのポート、右側がDockerのポートです。
  - `-v`で設定ファイルや設定ファイルを含むディレクトリをマウントします。要するにDockerが設定ファイルにアクセスできるようにします。
  - 最後の実行するdocker imageを指定します。
```bash
# prometheus.ymlファイルをマウントする場合
sudo docker run \
    -d \
    -p 9090:9090 \
    -v ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml \
    prom/prometheus
# prometheus.ymlを含むディレクトリをマウントする場合
sudo docker run \
    -d \
    -p 9090:9090 \
    -v ./prometheus/:/etc/prometheus/ \
    prom/prometheus
```
- 以下のように実行確認を行います。
```bash
$ sudo docker ps 
CONTAINER ID   IMAGE             COMMAND                   CREATED         STATUS         PORTS                                       NAMES
37b6ca93deaf   prom/prometheus   "/bin/prometheus --c…"   5 seconds ago   Up 3 seconds   0.0.0.0:9090->9090/tcp, :::9090->9090/tcp   jolly_lamport
$ curl localhost:9090
<a href="/graph">Found</a>.
```
- dockerを停止するには、`docker ps`で表示されたIDを用いて以下のようにコマンド打ちます。
```bash
$ sudo docker rm -f 37b6ca93deaf
```
## docker-composeを用いた設定
- 特に参考にした記事
  - [Prometheus + AlertManager + Grafana + Node Exporter with Docker - Qiita](https://qiita.com/Esfahan/items/0feaedfd771f49ac7ee4)
- ディレクトリ構成
```text
.
├── docker-compose.yaml
└── prometheus
    └── prometheus.yml
```
- docker volumeを作成します。
```bash
$ sudo docker volume create metrics_data
```
- `docker-compose.yaml`を以下のように設定します。
```yaml:docker-compose.yaml
version: '3'
services:
  prometheus:
    image: prom/prometheus
    container_name: prometheus
    hostname: prometheus
    volumes:
      - ./prometheus:/etc/prometheus
      - metrics_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yaml"
    ports:
      - 9090:9090
    restart: always

volumes:
  metrics_data:
    external: true
```
- `prometheus/prometheus.yml`を最初に示した`prometheus.yml`と同じにします。
- dockerの起動
  - `-d`オプションを渡すことでバックグランドで実行することができます。
```bash
$ sudo docker-compose up -d
```
- `docker ps`コマンドで実行状況を確認します。以下のようになっていれば成功です。
```bash
$ sudo docker ps
CONTAINER ID   IMAGE             COMMAND                   CREATED         STATUS         PORTS                                       NAMES
1fbccbbfe103   prom/prometheus   "/bin/prometheus --c…"   5 seconds ago   Up 2 seconds   0.0.0.0:9090->9090/tcp, :::9090->9090/tcp   prometheus
```
- dockerを終了する場合は、以下のコマンドを使用します。
```bash
$ sudo docker-compose down
```
## バイナリファイルを用いた設定
- 公式のチュートリアルページ
  - [Getting started | Prometheus](https://prometheus.io/docs/prometheus/latest/getting_started/)
- 以下のサイトからPrometheusの最新バージョンを調べてください。
  - [Download | Prometheus](https://prometheus.io/download/)
- 調べたリンク先の`tar`ファイルを`wget`コマンドで取得します。
```bash
$ wget https://github.com/prometheus/prometheus/releases/download/v2.43.0-rc.0/prometheus-2.43.0-rc.0.linux-amd64.tar.gz
```
- その後、`tar`コマンドを用いてダウンロードしたファイルを解凍します。
```bash
$ tar xvfz prometheus-2.43.0-rc.0.linux-amd64.tar.gz
```
- 解凍して生成されたフォルダをVSCodeなどのテキストエディターで開きます。
- フォルダ直下の`prometheus.yml`を上述の通りに設定します。
- 以下のコマンドで Prometheusサーバーに設定ファイルを渡して起動することができます。
```bash
# フォアグランドで実行する場合
$ ./prometheus --config.file=prometheus.yml
# バックグランドで実行する場合
$ nohup ./prometheus --config.file=prometheus.yml &
```
- 以下のコマンドを入力して次のように表示されればインストール成功です。
```bash
$ curl localhost:9090
<a href="/graph">Found</a>.
```
- フォアグラウンドで実行した場合、`Ctrl+C`でプログラムを停止できます。
- バックグランドで実行した場合、まず以下のコマンドでプロセスIDを調べてください
```bash
$ jobs -l
[1]+ 1062985 実行中               nohup ./prometheus --config.file=prometheus.yml &
```
- その後、`kill`コマンドでプロセスを停止します。
```bash
$ kill 1062985
```

# 監視対象のサーバーにNode Exporterを設定する
このセクションでは、`docker run`を用いたNode Exporterの設定方法のみをフォローしています。バイナリファイルを用いた設定を行いたい場合は公式ページを参考にしてください。
- dockerを用いる場合は、以下のコマンド1行ですみます。
```bash
$ sudo docker run -d --name=node_exporter -p 9100:9100 prom/node-exporter
# 実行確認
$ sudo docker ps
CONTAINER ID   IMAGE                COMMAND                CREATED         STATUS         PORTS                                       NAMES
949ac00e254b   prom/node-exporter   "/bin/node_exporter"   4 seconds ago   Up 2 seconds   0.0.0.0:9100->9100/tcp, :::9100->9100/tcp   node_exporter
```
- Node Exporterが送信する情報をPrometheusが動作しているサーバーで受け取る必要があります。まず、Prometheusが動作しているサーバーから監視対象のNode Exporterの情報を取得できるかチェックします。以下のように表示されれば成功です。

```bash
$ curl {監視対象のIPアドレス}:9100
<html>
  <head><title>Node Exporter</title></head>
  <body>
  <h1>Node Exporter</h1>
  <p><a href="/metrics">Metrics</a></p>
  </body>
</html>
```
- Node Exporterを監視対象に設置したらPrometheusサーバーの`prometheus.yml`を次のように変更します。(必要な部分だけ抜き出しています)
```yaml
static_configs:
  - targets: ['{監視対象1のIPアドレス}:9100',
              '{監視対象2のIPアドレス}:9100',]
```

# Grafanaで綺麗に可視化する
このセクションでは、`docker run`を用いたGrafanaの設定方法のみをフォローしています。バイナリファイルを用いた設定を行いたい場合は公式ページを参考にしてください。
## Grafanaのセットアップ
- 公式のDocker image
  - [grafana/grafana - Docker Image | Docker Hub](https://hub.docker.com/r/grafana/grafana/)
- dockerを用いる場合は、以下のコマンド1行ですみます。
  - 次のdockerコマンドを実行するのはPrometheusサーバーでもそれ以外でも大丈夫です。自分の場合、PrometheusサーバーにGrafanaも立てています。
```bash
$ sudo docker run -d --name=grafana -p 3000:3000 grafana/grafana-enterprise
# 実行確認
$ sudo docker ps 
CONTAINER ID   IMAGE                        COMMAND                CREATED         STATUS         PORTS                                       NAMES
b90393b404e2   grafana/grafana-enterprise   "/run.sh"              3 minutes ago   Up 3 minutes   0.0.0.0:3000->3000/tcp, :::3000->3000/tcp   grafana
# dockerが起動してからGrafanaが立ち上がるまではラグがあります
# しばらく待ってから以下を実行してください
$ curl {grafanaサーバーのIPアドレス}:3000
<a href="/login">Found</a>.
```
- 以上が確認できればGrafanaのセットアップは完了です。
## Grafanaの基本的な使い方
- 次に基本的なGrafahaの使い方を解説します。
- まず、ブラウザで`{grafanaサーバーのIPアドレス}:3000`にアクセスします。すると、次のような画面が表示されます。
<!-- - 　Grafanaのログイン画面の挿入 -->
## Node Exporterから得られた情報を綺麗に可視化
- Node Exoprterで取得した情報をGrafanaで可視化する際に用いるダッシュボード
  - [Node Exporter Full | Grafana Labs](https://grafana.com/grafana/dashboards/1860-node-exporter-full/)

![](/images/a612bf497c59ca/2023-03-11-13-42-49.png)
- 上のようなすでに用意されたダッシュボードを利用するために次のような設定を行います。
# 参考記事

- [よく使いそうなPrometheusのexporter一覧](https://zenn.dev/mttk030/articles/b4c85b02f7c750)
  - よく使うExporterとGrafanaで使えるダッシュボードがまとめられています。多様なExporterを使うことでさまざまな情報を収集でき、Grafanaで綺麗に可視化することができます。