---
title: "PrometheusとNode Exporterで収集した情報をGrafanaで可視化する"
emoji: "👻"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["linux","docker","prometheus",'grafana']
published: false
---
# この記事の概要


# 情報収集用のサーバーにPrometheusの設定を行う
- `prometheus.yml` の中身は設定方法によらず同一です。
```yaml:prometheus.yml
global:
  scrape_interval:     15s # By default, scrape targets every 15 seconds.
  external_labels:
    monitor: 'codelab-monitor'

scrape_configs:
  - job_name: prometheus
    metrics_path: /metrics
    scrape_interval: 5s
    static_configs:
      - targets: ['localhost:9000']
      - targets: ['{監視対象のIPアドレス}:9100']
```
## docker runのみを用いて設定する場合
- 公式のDocker image
  - [prom/prometheus - Docker Image | Docker Hub](https://hub.docker.com/r/prom/prometheus)
- 以下のコマンドとオプションについて説明します。
  - `docker run`でdocker imageを起動します。imageがローカルにない場合は、インターネット上から自動的に取得してくれます。
  - そのままだとフォアグラウンドで実行されるので、`-d`をつけてバックグランドで起動します。
  - `-p`でポートを指定します。左側がホストのポート、右側がDockerのポートです。
  - `-v`で設定ファイルや設定ファイルを含むディレクトリをマウントします。要するにDockerが設定ファイルにアクセスできるようにします。
  - 最後の実行するdocker imageを指定します。
```bash
# prometheus.ymlファイルをマウントする場合
sudo docker run \
    -d \
    -p 9090:9090 \
    -v ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml \
    prom/prometheus
# prometheus.ymlを含むディレクトリをマウントする場合
sudo docker run \
    -d \
    -p 9090:9090 \
    -v ./prometheus/:/etc/prometheus/ \
    prom/prometheus
```
- 以下のように実行確認を行います。
```bash
$ sudo docker ps 
CONTAINER ID   IMAGE             COMMAND                   CREATED         STATUS         PORTS                                       NAMES
37b6ca93deaf   prom/prometheus   "/bin/prometheus --c…"   5 seconds ago   Up 3 seconds   0.0.0.0:9090->9090/tcp, :::9090->9090/tcp   jolly_lamport
$ curl localhost:9090
<a href="/graph">Found</a>.
```
- dockerを停止するには、`docker ps`で表示されたIDを用いて以下のようにコマンド打ちます。
```bash
$ sudo docker rm -f 37b6ca93deaf
```
## docker-composeを用いて設定する場合
- 特に参考にした記事
  - [Prometheus + AlertManager + Grafana + Node Exporter with Docker - Qiita](https://qiita.com/Esfahan/items/0feaedfd771f49ac7ee4)
- ディレクトリ構成
```text
.
├── docker-compose.yaml
└── prometheus
    └── prometheus.yml
```
- docker volumeを作成します。
```bash
$ sudo docker volume create metrics_data
```
- `docker-compose.yaml`を以下のように設定します。
```yaml:docker-compose.yaml
version: '3'
services:
  prometheus:
    image: prom/prometheus
    container_name: prometheus
    hostname: prometheus
    volumes:
      - ./prometheus:/etc/prometheus
      - metrics_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yaml"
    ports:
      - 9090:9090
    restart: always

volumes:
  metrics_data:
    external: true
```
- `prometheus/prometheus.yml`を上述の通りに設定します。
- dockerの起動
  - `-d`オプションを渡すことでバックグランドで実行することができます。
```bash
$ sudo docker-compose up -d
```
- `docker ps`コマンドで実行状況を確認します。以下のようになっていれば成功です。
```bash
$ sudo docker ps
CONTAINER ID   IMAGE             COMMAND                   CREATED         STATUS         PORTS                                       NAMES
1fbccbbfe103   prom/prometheus   "/bin/prometheus --c…"   5 seconds ago   Up 2 seconds   0.0.0.0:9090->9090/tcp, :::9090->9090/tcp   prometheus
```
- dockerを終了する場合は、以下のコマンドを使用します。
```bash
$ sudo docker-compose down
```
## バイナリファイルを用いて設定する場合
- 公式のチュートリアルページ
  - [Getting started | Prometheus](https://prometheus.io/docs/prometheus/latest/getting_started/)
- 以下のサイトからPrometheusの最新バージョンを調べてください。
  - [Download | Prometheus](https://prometheus.io/download/)
- 調べたリンク先の`tar`ファイルを`wget`コマンドで取得します。
```bash
$ wget https://github.com/prometheus/prometheus/releases/download/v2.43.0-rc.0/prometheus-2.43.0-rc.0.linux-amd64.tar.gz
```
- その後、`tar`コマンドを用いてダウンロードしたファイルを解凍します。
```bash
$ tar xvfz prometheus-2.43.0-rc.0.linux-amd64.tar.gz
```
- 解凍して生成されたフォルダをVSCodeなどのテキストエディターで開きます。
- フォルダ直下の`prometheus.yml`を上述の通りに設定します。
- 以下のコマンドで Prometheusサーバーに設定ファイルを渡して起動することができます。
```bash
# フォアグランドで実行する場合
$ ./prometheus --config.file=prometheus.yml
# バックグランドで実行する場合
$ nohup ./prometheus --config.file=prometheus.yml &
```
- 以下のコマンドを入力して次のように表示されればインストール成功です。
```bash
$ curl localhost:9090
<a href="/graph">Found</a>.
```
- フォアグラウンドで実行した場合、`Ctrl+C`でプログラムを停止できます。
- バックグランドで実行した場合、まず以下のコマンドでプロセスIDを調べてください
```bash
$ jobs -l
[1]+ 1062985 実行中               nohup ./prometheus --config.file=prometheus.yml &
```
- その後、`kill`コマンドでプロセスを停止します。
```bash
$ kill 1062985
```
# 監視対象のサーバーにNode Exporterの設定を行う


# Grafanaで綺麗に可視化する
